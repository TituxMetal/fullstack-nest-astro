---
epic: '2'
story_id: '2.4'
title: 'Dissolve Token Module into Auth Infrastructure'
status: 'Approved'
priority: 'CRITICAL'
as_a: 'developer working on the authentication system'
i_want: 'the Token module dissolved and its functionality moved into the Auth module infrastructure'
so_that: 'we eliminate architectural debt and maintain proper bounded context boundaries'
acceptance_criteria:
  # Token Service Migration
  - 'AC2.4.1: Move TokenService functionality to auth/infrastructure/services/Token.service.ts with
    class name TokenService (not JwtService to avoid naming conflicts), including generateToken()
    and verifyToken() methods with identical signatures and behavior'
  # Interface Migration
  - 'AC2.4.2: Move JwtPayload interface to auth/domain/value-objects/JwtPayload.vo.ts with class
    name JwtPayloadValueObject containing validation logic, and create corresponding interface
    IJwtPayload for type definitions'
  # Dependency Updates
  - 'AC2.4.3: Update Auth.module.ts to include JwtModule configuration previously in TokenModule,
    ensuring proper ConfigService injection for JWT secret and expiration settings'
  # Import Path Updates
  - 'AC2.4.4: Update all imports across the codebase: change "~/token" imports to
    "~/auth/infrastructure/services" for TokenService and "~/auth/domain/value-objects" for JWT
    payload types'
  # Module Cleanup
  - 'AC2.4.5: Remove token/ directory completely after successful migration, including
    token.module.ts, token.service.ts, token.service.spec.ts, interfaces/, and index.ts'
  # Integration Verification
  - 'IV2.4.1: JWT token generation works identically via Auth module'
  - 'IV2.4.2: JWT token verification works identically via Auth module'
  - 'IV2.4.3: All auth endpoints continue to function normally'
  - 'IV2.4.4: Users controller authentication continues to work'
  - 'IV2.4.5: All existing tests pass with updated imports'
---

## Tasks / Subtasks

- [ ] **Task 1: Create JWT Domain Value Object** (AC: 2.4.2)
  - [ ] Create `auth/domain/value-objects/JwtPayload.vo.ts` with
        `export class JwtPayloadValueObject`
  - [ ] Create `auth/domain/value-objects/JwtPayload.vo.spec.ts` for comprehensive testing
  - [ ] Add validation logic for sub, identifier, iat, exp fields
  - [ ] Create `IJwtPayload` interface for type definitions
  - [ ] Update `auth/domain/value-objects/index.ts` barrel file to export new value object

- [ ] **Task 2: Migrate Token Service to Auth Infrastructure** (AC: 2.4.1)
  - [ ] Create `auth/infrastructure/services/Token.service.ts` with `export class TokenService`
  - [ ] Migrate `generateToken()` method from original TokenService with identical behavior
  - [ ] Migrate `verifyToken()` method from original TokenService with identical behavior
  - [ ] Create `auth/infrastructure/services/Token.service.spec.ts` with comprehensive tests
  - [ ] Update `auth/infrastructure/services/index.ts` barrel file to export TokenService
  - [ ] Ensure proper dependency injection for ConfigService, JwtService, and PrismaService

- [ ] **Task 3: Update Auth Module Configuration** (AC: 2.4.3)
  - [ ] Update `auth/Auth.module.ts` to import JwtModule with proper configuration
  - [ ] Add JwtModule.registerAsync with ConfigService injection for secret and expiration
  - [ ] Register TokenService as a provider in Auth.module.ts
  - [ ] Export TokenService from Auth.module.ts for external use
  - [ ] Ensure all JWT configuration matches original TokenModule setup

- [ ] **Task 4: Update Import Paths Across Codebase** (AC: 2.4.4)
  - [ ] Update `apps/backend/src/users/User.controller.spec.ts` TokenService import
  - [ ] Update `apps/backend/src/users/Users.module.ts` to import from Auth module instead of Token
        module
  - [ ] Update `apps/backend/src/app.module.ts` to remove TokenModule import
  - [ ] Search for any other files importing from `~/token` and update them
  - [ ] Verify all import paths use proper barrel file imports

- [ ] **Task 5: Remove Token Module** (AC: 2.4.5)
  - [ ] Verify all functionality works with new Auth-based implementation
  - [ ] Run all existing tests to ensure no regressions
  - [ ] Remove `apps/backend/src/token/` directory completely
  - [ ] Clean up any remaining references to TokenModule in configuration files
  - [ ] Verify build succeeds without token module

- [ ] **Task 6: Integration Verification** (IV: 2.4.1-2.4.5)
  - [ ] Test JWT token generation maintains exact same behavior
  - [ ] Test JWT token verification maintains exact same behavior
  - [ ] Test all auth endpoints (login, register, logout) continue to function normally
  - [ ] Test users controller authentication continues to work with updated imports
  - [ ] Ensure all existing tests pass with updated import paths

## Dev Notes

### Architectural Debt Context

From Story 2.2 QA review, the Token module was identified as a critical architectural violation:

**"Token Module: Should be part of Auth infrastructure, not standalone"**

This standalone Token module violates Clean Architecture and DDD principles:

- **Bounded Context Violation**: Token generation/verification is core Auth domain behavior
- **Infrastructure Leak**: JWT implementation details spread across multiple modules
- **Dependency Confusion**: Creates circular dependencies between Auth and Token modules
- **Testing Complexity**: Requires mocking TokenService in Auth tests instead of internal behavior

[Source: docs/stories/2.2.story.md#QA Results - Broader Architectural Analysis]

### Target Architecture

**After Migration - Proper Bounded Context:**

```treeview
apps/backend/src/auth/
├── Auth.module.ts (includes JWT configuration)
├── domain/
│   ├── value-objects/
│   │   ├── JwtPayload.vo.ts (domain validation logic)
│   │   └── index.ts
├── infrastructure/
│   ├── services/
│   │   ├── Token.service.ts (JWT generation/verification)
│   │   ├── Jwt.service.ts (auth-specific JWT operations)
│   │   ├── Password.service.ts
│   │   └── index.ts
```

**Benefits of This Architecture:**

- **Single Responsibility**: Auth module owns all authentication concerns
- **Clean Dependencies**: No external token module dependency
- **Better Testing**: Internal token operations can be tested as part of Auth behavior
- **Domain Alignment**: JWT payload becomes a proper domain value object with validation
- **Infrastructure Cohesion**: All JWT-related infrastructure services co-located

### Current Token Module Analysis

**Files to Migrate:**

- `token/token.service.ts` → `auth/infrastructure/services/Token.service.ts`
- `token/interfaces/jwt-payload.interface.ts` → `auth/domain/value-objects/JwtPayload.vo.ts`
- `token/token.service.spec.ts` → `auth/infrastructure/services/Token.service.spec.ts`
- `token/token.module.ts` functionality → `auth/Auth.module.ts` (JWT configuration)

**Dependencies to Update:**

- `users/User.controller.spec.ts` - Update TokenService import
- `users/Users.module.ts` - Remove TokenModule import, add dependency on Auth module
- `app.module.ts` - Remove TokenModule import

### Migration Strategy

**Zero-Downtime Approach:**

1. **Create New Structure**: Build TokenService in Auth infrastructure with identical API
2. **Update Dependencies**: Change import paths to point to Auth module
3. **Verify Functionality**: Ensure all existing behavior works unchanged
4. **Remove Old Module**: Delete token/ directory only after verification

**Critical Preservation Requirements:**

- Identical method signatures for `generateToken()` and `verifyToken()`
- Same JWT configuration (secret, expiration from ConfigService)
- Preserve all error handling and validation behavior
- Maintain same dependency injection patterns

### JWT Configuration Details

**Original TokenModule Configuration:**

```typescript
JwtModule.registerAsync({
  imports: [ConfigModule],
  inject: [ConfigService],
  useFactory: (configService: ConfigService) => ({
    secret: configService.jwt.secret,
    signOptions: { expiresIn: configService.jwt.expiresIn }
  })
})
```

**Target Auth.module.ts Configuration:**

- Must include identical JwtModule configuration
- ConfigService injection for JWT settings
- TokenService registration as provider and export

### Domain Value Object Design

**JwtPayload Value Object:**

```typescript
export class JwtPayloadValueObject {
  constructor(
    private readonly sub: string,
    private readonly identifier: string,
    private readonly iat?: number,
    private readonly exp?: number
  ) {
    this.validate()
  }

  private validate(): void {
    // Domain validation logic for JWT payload
  }

  // Getters and domain methods
}

export interface IJwtPayload {
  sub: string
  identifier: string
  iat?: number
  exp?: number
}
```

This approach provides:

- Domain validation for JWT payload structure
- Type safety through interface
- Encapsulation of JWT payload business rules
- Clear separation between domain logic and infrastructure implementation

### Testing Strategy

**Comprehensive Test Coverage:**

- Unit tests for JwtPayload value object validation
- Integration tests for TokenService in Auth infrastructure context
- End-to-end tests for auth endpoints to verify no regressions
- Migration verification tests to ensure identical behavior

**Test File Locations:**

- `auth/domain/value-objects/JwtPayload.vo.spec.ts`
- `auth/infrastructure/services/Token.service.spec.ts`
- Existing auth integration tests should continue to pass

### File Locations and Path Standards

**New Import Paths:**

- TokenService: `import { TokenService } from '~/auth/infrastructure/services'`
- JWT Payload: `import { IJwtPayload, JwtPayloadValueObject } from '~/auth/domain/value-objects'`
- All imports use barrel files for clean dependency management

**Directory Structure After Migration:**

```treeview
apps/backend/src/
├── auth/
│   ├── Auth.module.ts (includes JWT module config)
│   ├── domain/
│   │   ├── value-objects/
│   │   │   ├── JwtPayload.vo.ts
│   │   │   ├── JwtPayload.vo.spec.ts
│   │   │   └── index.ts
│   └── infrastructure/
│       └── services/
│           ├── Token.service.ts
│           ├── Token.service.spec.ts
│           ├── Jwt.service.ts
│           ├── Password.service.ts
│           └── index.ts
├── users/
│   └── [existing structure with updated imports]
└── [no token/ directory]
```

### Risk Assessment

**Risk Level: MEDIUM** - Module dissolution requires careful dependency management

**Mitigation Strategies:**

1. **Incremental Migration**: Build new structure before removing old
2. **Comprehensive Testing**: Verify every import path and functionality
3. **Rollback Plan**: Keep token module until all tests pass
4. **Integration Verification**: Test all dependent modules (Users, Auth)

**Critical Dependencies:**

- Users module depends on TokenService for authentication
- Auth module uses JWT configuration for login/logout
- Any middleware or guards using JWT functionality

## Testing

### Testing Standards

**Framework and Location:**

- Jest 29.7.0 for backend testing
- Co-locate `*.spec.ts` files with source files
- Use ~/path alias in test imports

**Testing Patterns:**

- TDD approach: RED-GREEN-REFACTOR cycle
- AAA pattern: Arrange-Act-Assert structure
- 90%+ coverage through comprehensive unit tests
- Domain layer tests focus on business logic without infrastructure
- Integration tests verify infrastructure components work with domain

**Test Categories:**

- Unit tests (85%): JwtPayload value object, TokenService logic
- Integration tests (15%): Auth module configuration, endpoint behavior
- Migration verification tests: Ensure identical behavior after migration
- Mock external dependencies (ConfigService, PrismaService) in unit tests

### Migration-Specific Testing

**Pre-Migration Tests:**

- Document current TokenService behavior
- Capture JWT generation patterns
- Record authentication flow expectations

**Post-Migration Verification:**

- Identical token generation output for same inputs
- Same validation errors for invalid payloads
- Auth endpoints return identical responses
- Users controller authentication works unchanged

## Change Log

| Date       | Version | Description                                         | Author                |
| ---------- | ------- | --------------------------------------------------- | --------------------- |
| 2025-09-02 | 1.0     | Initial story creation for Token module dissolution | Claude (PM & Crafter) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled during implementation_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

**Files to be Created:**

Domain Layer:

- `apps/backend/src/auth/domain/value-objects/JwtPayload.vo.ts`
- `apps/backend/src/auth/domain/value-objects/JwtPayload.vo.spec.ts`

Infrastructure Layer:

- `apps/backend/src/auth/infrastructure/services/Token.service.ts`
- `apps/backend/src/auth/infrastructure/services/Token.service.spec.ts`

**Files to be Modified:**

- `apps/backend/src/auth/Auth.module.ts` - Add JWT module configuration and TokenService
- `apps/backend/src/auth/domain/value-objects/index.ts` - Export JwtPayload value object
- `apps/backend/src/auth/infrastructure/services/index.ts` - Export TokenService
- `apps/backend/src/users/User.controller.spec.ts` - Update TokenService import path
- `apps/backend/src/users/Users.module.ts` - Remove TokenModule import, use Auth module
- `apps/backend/src/app.module.ts` - Remove TokenModule import

**Files to be Deleted:**

- `apps/backend/src/token/` (entire directory)
- `apps/backend/src/token/token.module.ts`
- `apps/backend/src/token/token.service.ts`
- `apps/backend/src/token/token.service.spec.ts`
- `apps/backend/src/token/interfaces/jwt-payload.interface.ts`
- `apps/backend/src/token/interfaces/index.ts`
- `apps/backend/src/token/index.ts`

## QA Results

_This section will be populated by the QA agent during review_

### Review Date

_To be filled during review_

### Reviewed By

_To be filled during review_

### Code Quality Assessment

_To be filled during review_

### Refactoring Performed

_To be filled during review_

### Compliance Check

_To be filled during review_

### Requirements Traceability

_To be filled during review_

### Recommended Status

_To be filled during review_
