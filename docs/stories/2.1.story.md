---
epic: '2'
story_id: '2.1'
title: 'Establish Clean Architecture + DDD Directory Structure'
status: 'Done'
as_a: 'developer working on backend architecture'
i_want: 'the new Clean Architecture directory structure created alongside existing code'
so_that: 'I can incrementally migrate modules without breaking existing functionality'
acceptance_criteria:
  # Directory Structure
  - 'AC2.1.1: Create `apps/backend/src/contexts/` directory structure with auth/, user/, and shared/
    bounded contexts, each containing domain/, application/, and infrastructure/ layers'
  - 'AC2.1.2: Add architectural documentation in `apps/backend/docs/architecture.md` explaining
    Clean Architecture + DDD principles'
  - 'AC2.1.3: Create template files showing expected patterns for each layer'
  - 'AC2.1.4: All existing modules (auth/, user/, etc.) remain untouched and functional'
  # Integration Verification
  - 'IV2.1.1: Existing API endpoints continue to work normally'
  - 'IV2.1.2: All authentication flows remain functional'
  - 'IV2.1.3: User profile operations work without changes'
  - 'IV2.1.4: All existing tests pass'
---

## Tasks / Subtasks

- [x] **Task 1: Create Clean Architecture Directory Structure** (AC: 2.1.1)
  - [x] Create `apps/backend/src/contexts/` root directory
  - [x] Create `contexts/auth/` bounded context with domain/, application/, infrastructure/ layers
  - [x] Create `contexts/user/` bounded context with domain/, application/, infrastructure/ layers
  - [x] Create `contexts/shared/` bounded context with domain/, infrastructure/ layers
  - [x] Verify directory structure matches target architecture from source-tree.md

- [x] **Task 2: Create Architectural Documentation** (AC: 2.1.2)
  - [x] Create `apps/backend/docs/` directory
  - [x] Write `apps/backend/docs/architecture.md` with Clean Architecture + DDD principles
  - [x] Document layer responsibilities and dependency rules
  - [x] Include bounded context explanations specific to this project

- [x] **Task 3: Create Template Files for Each Layer** (AC: 2.1.3)
  - [x] Create domain entity template in `contexts/shared/domain/entities/_template.entity.ts`
  - [x] Create repository interface template in
        `contexts/shared/domain/repositories/_template.repository.ts`
  - [x] Create use case template in `contexts/shared/application/useCases/_template.usecase.ts`
  - [x] Create infrastructure repository template in
        `contexts/shared/infrastructure/repositories/_template.repository.ts`
  - [x] Create controller template in
        `contexts/shared/infrastructure/controllers/_template.controller.ts`

- [x] **Task 4: Verify Existing System Integrity** (AC: 2.1.4, IV: 2.1.1-2.1.4)
  - [x] Run all existing tests to ensure they pass
  - [x] Test POST /auth/login endpoint functionality
  - [x] Test POST /auth/register endpoint functionality
  - [x] Test GET /users/me endpoint functionality
  - [x] Test PUT /users/me endpoint functionality
  - [x] Verify application starts successfully with new directory structure present

## Dev Notes

### Previous Story Insights

From Story 1.1 completion, key lessons learned:

- **Zero Breaking Changes**: All import paths, configurations, and functionality must be preserved
  [Source: docs/stories/1.1.story.md#Dev Agent Record]
- **Atomic Implementation**: Complete restructuring delivered as one cohesive, testable unit
  [Source: docs/stories/1.1.story.md#Dev Agent Record]
- **Future-Proof Design**: Structure ready for additional apps and shared packages [Source:
  docs/stories/1.1.story.md#Dev Agent Record]

### Architecture Context

**Clean Architecture + DDD Principles:**

- **Dependency Rule**: Domain layer dependencies point inward only, no outward dependencies [Source:
  docs/architecture/high-level-architecture.md#Clean Architecture Layers]
- **Bounded Context Separation**: Auth context focuses on authentication, User context on profile
  management [Source: docs/architecture/data-models.md#Bounded Context Field Mapping]
- **Layer Responsibilities**: Domain → business logic, Application → use cases, Infrastructure →
  external concerns [Source: docs/architecture/high-level-architecture.md#Clean Architecture Layers]

**Target Directory Structure:** The exact structure to be created is defined in [Source:
docs/architecture/source-tree.md#Target Project Structure]:

```treeview
apps/backend/src/contexts/
├── auth/
│   ├── domain/
│   ├── application/
│   └── infrastructure/
├── user/
│   ├── domain/
│   ├── application/
│   └── infrastructure/
└── shared/
    ├── domain/
    └── infrastructure/
```

**File Naming Conventions:**

- Use CamelCase/PascalCase for all files (existing pattern maintained) [Source:
  docs/architecture/coding-standards.md#Naming Conventions]
- Domain Entities: PascalCase with context suffix (e.g., AuthUser, UserProfile) [Source:
  docs/architecture/coding-standards.md#Naming Conventions]
- Use Cases: PascalCase with UseCase suffix (e.g., LoginUseCase) [Source:
  docs/architecture/coding-standards.md#Naming Conventions]
- Repository Interfaces: PascalCase with Repository suffix [Source:
  docs/architecture/coding-standards.md#Naming Conventions]
- Repository Implementations: PascalCase with provider prefix (e.g., PrismaAuthUserRepository)
  [Source: docs/architecture/coding-standards.md#Naming Conventions]

**Data Models and Contexts:**

- **Auth Context**: Uses fields id, email, username, hash, confirmed, blocked, createdAt [Source:
  docs/architecture/data-models.md#Bounded Context Field Mapping]
- **User Context**: Uses fields id, email, username, firstName, lastName, createdAt, updatedAt
  [Source: docs/architecture/data-models.md#Bounded Context Field Mapping]
- **Shared Fields**: id (entity identity), email/username (shared identifiers) [Source:
  docs/architecture/data-models.md#Bounded Context Field Mapping]
- **Keep Exact Prisma Schema**: No database changes, domain entities model business behavior around
  existing data [Source: docs/architecture/data-models.md#Epic 2 Implementation Strategy]

**API Contract Preservation:** All existing endpoints must maintain exact behavior:

- POST /auth/register, POST /auth/login, POST /auth/logout [Source:
  docs/architecture/rest-api-spec.md#paths]
- GET /users/me, PUT /users/me [Source: docs/architecture/rest-api-spec.md#paths]
- Same request/response schemas and authentication mechanisms [Source:
  docs/architecture/rest-api-spec.md#Epic 2 Implementation Guarantee]

### Project Structure Notes

- Current project uses apps/ structure from Epic 1 completion [Source:
  docs/stories/1.1.story.md#Status]
- Backend is located at `apps/backend/` [Source: docs/architecture/source-tree.md#Target Project
  Structure]
- All ~/path aliases and import patterns must be maintained [Source:
  docs/architecture/coding-standards.md#Import Path Standards]

### Technical Constraints

- **Tech Stack**: NestJS 11.1.1, TypeScript 5.8.3+, Node.js 22.17.0 [Source:
  docs/architecture/tech-stack.md#Technology Stack Table]
- **Database**: SQLite with Prisma ORM 6.8.2 [Source: docs/architecture/tech-stack.md#Technology
  Stack Table]
- **No External APIs**: Self-contained application design [Source:
  docs/architecture/external-apis.md]

## Testing

**Testing Standards to Follow:**

- **File Location**: `*.spec.ts` files co-located with source files [Source:
  docs/architecture/test-strategy-and-standards.md#Current Testing Stack]
- **Framework**: Jest 29.7.0 for backend testing [Source:
  docs/architecture/test-strategy-and-standards.md#Current Testing Stack]
- **Pattern**: AAA (Arrange-Act-Assert) structure [Source:
  docs/architecture/test-strategy-and-standards.md#Current Testing Stack]
- **TDD Approach**: Red-green-refactor cycle for learning Clean Architecture + DDD [Source:
  docs/architecture/test-strategy-and-standards.md#Testing Philosophy]
- **Coverage Goals**: 90%+ through TDD [Source:
  docs/architecture/test-strategy-and-standards.md#Testing Philosophy]

**Specific Testing Requirements for this Story:**

- No new tests required for this story since only creating directory structure and templates
- Verify all existing tests continue to pass after directory creation
- Template files should include example test structures following TDD patterns
- Integration verification through manual testing of existing endpoints

**Test Configuration (Maintain Current):**

- moduleNameMapper: "~/(.\*)$": "<rootDir>/src/$1" [Source:
  docs/architecture/test-strategy-and-standards.md#Test Configuration]
- testRegex: ".\*\\.spec\\.ts$" [Source: docs/architecture/test-strategy-and-standards.md#Test
  Configuration]
- testEnvironment: "node" [Source: docs/architecture/test-strategy-and-standards.md#Test
  Configuration]

## Change Log

| Date       | Version | Description                                                                           | Author             |
| ---------- | ------- | ------------------------------------------------------------------------------------- | ------------------ |
| 2025-08-01 | 1.0     | Initial story creation for Clean Architecture + DDD directory structure establishment | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (via Cursor)

### Implementation Summary

Successfully implemented Clean Architecture + DDD directory structure alongside existing code with
zero breaking changes.

### Debug Log References

- **Git Workflow**: Followed proper git workflow with feature branch
  `story/2.1-clean-architecture-directory-structure`
- **Build Verification**: `yarn build` and `yarn test` executed to verify system integrity
- **All Tests Pass**: 68 frontend tests + 41 backend tests = 109 total tests passing

### Completion Notes List

1. ✅ **Directory Structure Created**: Complete contexts/ hierarchy with auth/, user/, shared/
   bounded contexts
2. ✅ **Architecture Documentation**: Comprehensive `apps/backend/docs/architecture.md` with Clean
   Architecture + DDD principles
3. ✅ **Template Files**: Complete set of templates for Domain (entities, repositories), Application
   (use cases), and Infrastructure (repositories, controllers) layers
4. ✅ **Zero Breaking Changes**: All existing tests pass, frontend builds successfully
5. ✅ **Ready for Migration**: Foundation in place for incremental migration of existing modules

### File List

- `apps/backend/src/contexts/` - Root contexts directory
- `apps/backend/src/contexts/auth/domain/` - Auth domain layer
- `apps/backend/src/contexts/auth/application/` - Auth application layer
- `apps/backend/src/contexts/auth/infrastructure/` - Auth infrastructure layer
- `apps/backend/src/contexts/user/domain/` - User domain layer
- `apps/backend/src/contexts/user/application/` - User application layer
- `apps/backend/src/contexts/user/infrastructure/` - User infrastructure layer
- `apps/backend/src/contexts/shared/domain/` - Shared domain layer
- `apps/backend/src/contexts/shared/infrastructure/` - Shared infrastructure layer
- `apps/backend/docs/architecture.md` - Architectural documentation
- `apps/backend/src/contexts/shared/domain/entities/_template.entity.ts` - Domain entity template
- `apps/backend/src/contexts/shared/domain/repositories/_template.repository.ts` - Repository
  interface template
- `apps/backend/src/contexts/shared/application/useCases/_template.usecase.ts` - Use case template
- `apps/backend/src/contexts/shared/infrastructure/repositories/_template.repository.ts` -
  Repository implementation template
- `apps/backend/src/contexts/shared/infrastructure/controllers/_template.controller.ts` - Controller
  template

## QA Results

### Review Date: 2025-08-01

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**Excellent implementation** that demonstrates sophisticated understanding of Clean Architecture +
DDD principles. The architecture documentation is comprehensive and well-structured, providing clear
guidance for future development. The template files show excellent attention to detail with rich
examples, comprehensive comments, and proper separation of concerns across all layers.

**Key Strengths:**

- Zero breaking changes achieved - all 41 backend tests + 68 frontend tests passing
- Comprehensive architectural documentation with practical examples
- Template files include extensive patterns, error handling, and usage examples
- Proper dependency rule implementation (Domain → Application → Infrastructure)
- Excellent bounded context separation with clear responsibilities

### Refactoring Performed

No refactoring was required. The implementation already follows best practices:

- Clean Architecture principles correctly applied
- Proper dependency injection patterns in templates
- Comprehensive error handling and validation examples
- Well-structured mapper patterns for data transformation
- Excellent documentation with practical usage examples

### Compliance Check

- **Coding Standards**: ✓ Follows project naming conventions, TypeScript patterns, and architectural
  guidelines
- **Project Structure**: ✓ Perfect alignment with target structure from
  docs/architecture/source-tree.md
- **Testing Strategy**: ✓ All existing tests pass, templates include comprehensive testing examples
- **All ACs Met**: ✓ All acceptance criteria and integration verification points satisfied

### Architecture Review

**Outstanding Clean Architecture implementation:**

- **Domain Layer Templates**: Rich entity patterns with business logic, value object examples, and
  proper encapsulation
- **Application Layer Templates**: Complete use case patterns with DTOs, validation, and exception
  handling
- **Infrastructure Layer Templates**: Comprehensive controller and repository implementations with
  NestJS integration
- **Dependency Rule Compliance**: Perfect inward-pointing dependencies, no violations detected
- **Bounded Context Design**: Clear separation between Auth, User, and Shared contexts with
  appropriate responsibilities

**Template Quality Highlights:**

- Entity template includes business behavior, validation, and immutability patterns
- Use case template shows proper orchestration, error handling, and DTO mapping
- Repository templates demonstrate both interface contracts and Prisma implementation
- Controller template includes comprehensive HTTP handling, validation, and error mapping

### Testing Excellence

- **Existing System Integrity**: All 109 tests (41 backend + 68 frontend) pass without modification
- **Template Testing Patterns**: Comprehensive testing examples included in all templates
- **TDD Guidance**: Templates show proper AAA pattern and mock usage
- **Coverage Strategy**: Templates demonstrate unit, integration, and e2e testing approaches

### Documentation Quality

**Exceptional architectural documentation** (apps/backend/docs/architecture.md):

- Clear explanation of Clean Architecture principles with practical examples
- Detailed bounded context descriptions with data model mapping
- Comprehensive implementation patterns with code examples
- Migration strategy clearly defined for incremental adoption
- Excellent visual representations and practical guidance

### Security Review

✓ No security concerns identified:

- Templates include proper validation patterns
- Error handling prevents information leakage
- Authentication patterns properly demonstrated in controller template
- Repository templates show proper data access patterns

### Performance Considerations

✓ Performance best practices included:

- Repository templates show efficient querying patterns
- Proper lazy loading and pagination examples
- Database optimization patterns in Prisma implementation
- Caching strategy examples provided in template comments

### Future Readiness

**Excellent foundation for migration:**

- Directory structure ready for incremental module migration
- Templates provide clear patterns for consistent implementation
- Zero breaking changes ensure safe migration path
- Comprehensive examples accelerate future development

### Improvements Checklist

All items successfully implemented:

- [x] Clean Architecture directory structure created with proper layer separation
- [x] Comprehensive architectural documentation with practical examples
- [x] Complete template files for all layers with rich examples and patterns
- [x] Zero breaking changes - all existing functionality preserved
- [x] Bounded context separation with clear responsibilities
- [x] Migration strategy documented for incremental adoption
- [x] Testing patterns and examples included in all templates
- [x] Error handling and validation patterns demonstrated
- [x] Repository pattern with both interface and implementation examples
- [x] Use case orchestration patterns with proper dependency injection

### Final Status

**✓ Approved - Ready for Done**

This implementation sets an excellent foundation for Clean Architecture + DDD adoption. The quality
of templates, documentation, and architectural guidance will significantly accelerate future
development while maintaining code quality standards. The zero-breaking-changes approach ensures
safe incremental migration of existing modules.
