---
epic: '2'
story_id: '2.1'
title: 'Establish Clean Architecture + DDD Directory Structure'
status: 'Approved'
as_a: 'developer working on backend architecture'
i_want: 'the new Clean Architecture directory structure created alongside existing code'
so_that: 'I can incrementally migrate modules without breaking existing functionality'
acceptance_criteria:
  # Directory Structure
  - 'AC2.1.1: Create `apps/backend/src/contexts/` directory structure with auth/, user/, and shared/
    bounded contexts, each containing domain/, application/, and infrastructure/ layers'
  - 'AC2.1.2: Add architectural documentation in `apps/backend/docs/architecture.md` explaining
    Clean Architecture + DDD principles'
  - 'AC2.1.3: Create template files showing expected patterns for each layer'
  - 'AC2.1.4: All existing modules (auth/, user/, etc.) remain untouched and functional'
  # Integration Verification
  - 'IV2.1.1: Existing API endpoints continue to work normally'
  - 'IV2.1.2: All authentication flows remain functional'
  - 'IV2.1.3: User profile operations work without changes'
  - 'IV2.1.4: All existing tests pass'
---

## Tasks / Subtasks

- [ ] **Task 1: Create Clean Architecture Directory Structure** (AC: 2.1.1)

  - [ ] Create `apps/backend/src/contexts/` root directory
  - [ ] Create `contexts/auth/` bounded context with domain/, application/, infrastructure/ layers
  - [ ] Create `contexts/user/` bounded context with domain/, application/, infrastructure/ layers
  - [ ] Create `contexts/shared/` bounded context with domain/, infrastructure/ layers
  - [ ] Verify directory structure matches target architecture from source-tree.md

- [ ] **Task 2: Create Architectural Documentation** (AC: 2.1.2)

  - [ ] Create `apps/backend/docs/` directory
  - [ ] Write `apps/backend/docs/architecture.md` with Clean Architecture + DDD principles
  - [ ] Document layer responsibilities and dependency rules
  - [ ] Include bounded context explanations specific to this project

- [ ] **Task 3: Create Template Files for Each Layer** (AC: 2.1.3)

  - [ ] Create domain entity template in `contexts/shared/domain/entities/_template.entity.ts`
  - [ ] Create repository interface template in
        `contexts/shared/domain/repositories/_template.repository.ts`
  - [ ] Create use case template in `contexts/shared/application/useCases/_template.usecase.ts`
  - [ ] Create infrastructure repository template in
        `contexts/shared/infrastructure/repositories/_template.repository.ts`
  - [ ] Create controller template in
        `contexts/shared/infrastructure/controllers/_template.controller.ts`

- [ ] **Task 4: Verify Existing System Integrity** (AC: 2.1.4, IV: 2.1.1-2.1.4)
  - [ ] Run all existing tests to ensure they pass
  - [ ] Test POST /auth/login endpoint functionality
  - [ ] Test POST /auth/register endpoint functionality
  - [ ] Test GET /users/me endpoint functionality
  - [ ] Test PUT /users/me endpoint functionality
  - [ ] Verify application starts successfully with new directory structure present

## Dev Notes

### Previous Story Insights

From Story 1.1 completion, key lessons learned:

- **Zero Breaking Changes**: All import paths, configurations, and functionality must be preserved
  [Source: docs/stories/1.1.story.md#Dev Agent Record]
- **Atomic Implementation**: Complete restructuring delivered as one cohesive, testable unit
  [Source: docs/stories/1.1.story.md#Dev Agent Record]
- **Future-Proof Design**: Structure ready for additional apps and shared packages [Source:
  docs/stories/1.1.story.md#Dev Agent Record]

### Architecture Context

**Clean Architecture + DDD Principles:**

- **Dependency Rule**: Domain layer dependencies point inward only, no outward dependencies [Source:
  docs/architecture/high-level-architecture.md#Clean Architecture Layers]
- **Bounded Context Separation**: Auth context focuses on authentication, User context on profile
  management [Source: docs/architecture/data-models.md#Bounded Context Field Mapping]
- **Layer Responsibilities**: Domain → business logic, Application → use cases, Infrastructure →
  external concerns [Source: docs/architecture/high-level-architecture.md#Clean Architecture Layers]

**Target Directory Structure:** The exact structure to be created is defined in [Source:
docs/architecture/source-tree.md#Target Project Structure]:

```treeview
apps/backend/src/contexts/
├── auth/
│   ├── domain/
│   ├── application/
│   └── infrastructure/
├── user/
│   ├── domain/
│   ├── application/
│   └── infrastructure/
└── shared/
    ├── domain/
    └── infrastructure/
```

**File Naming Conventions:**

- Use CamelCase/PascalCase for all files (existing pattern maintained) [Source:
  docs/architecture/coding-standards.md#Naming Conventions]
- Domain Entities: PascalCase with context suffix (e.g., AuthUser, UserProfile) [Source:
  docs/architecture/coding-standards.md#Naming Conventions]
- Use Cases: PascalCase with UseCase suffix (e.g., LoginUseCase) [Source:
  docs/architecture/coding-standards.md#Naming Conventions]
- Repository Interfaces: PascalCase with Repository suffix [Source:
  docs/architecture/coding-standards.md#Naming Conventions]
- Repository Implementations: PascalCase with provider prefix (e.g., PrismaAuthUserRepository)
  [Source: docs/architecture/coding-standards.md#Naming Conventions]

**Data Models and Contexts:**

- **Auth Context**: Uses fields id, email, username, hash, confirmed, blocked, createdAt [Source:
  docs/architecture/data-models.md#Bounded Context Field Mapping]
- **User Context**: Uses fields id, email, username, firstName, lastName, createdAt, updatedAt
  [Source: docs/architecture/data-models.md#Bounded Context Field Mapping]
- **Shared Fields**: id (entity identity), email/username (shared identifiers) [Source:
  docs/architecture/data-models.md#Bounded Context Field Mapping]
- **Keep Exact Prisma Schema**: No database changes, domain entities model business behavior around
  existing data [Source: docs/architecture/data-models.md#Epic 2 Implementation Strategy]

**API Contract Preservation:** All existing endpoints must maintain exact behavior:

- POST /auth/register, POST /auth/login, POST /auth/logout [Source:
  docs/architecture/rest-api-spec.md#paths]
- GET /users/me, PUT /users/me [Source: docs/architecture/rest-api-spec.md#paths]
- Same request/response schemas and authentication mechanisms [Source:
  docs/architecture/rest-api-spec.md#Epic 2 Implementation Guarantee]

### Project Structure Notes

- Current project uses apps/ structure from Epic 1 completion [Source:
  docs/stories/1.1.story.md#Status]
- Backend is located at `apps/backend/` [Source: docs/architecture/source-tree.md#Target Project
  Structure]
- All ~/path aliases and import patterns must be maintained [Source:
  docs/architecture/coding-standards.md#Import Path Standards]

### Technical Constraints

- **Tech Stack**: NestJS 11.1.1, TypeScript 5.8.3+, Node.js 22.17.0 [Source:
  docs/architecture/tech-stack.md#Technology Stack Table]
- **Database**: SQLite with Prisma ORM 6.8.2 [Source: docs/architecture/tech-stack.md#Technology
  Stack Table]
- **No External APIs**: Self-contained application design [Source:
  docs/architecture/external-apis.md]

## Testing

**Testing Standards to Follow:**

- **File Location**: `*.spec.ts` files co-located with source files [Source:
  docs/architecture/test-strategy-and-standards.md#Current Testing Stack]
- **Framework**: Jest 29.7.0 for backend testing [Source:
  docs/architecture/test-strategy-and-standards.md#Current Testing Stack]
- **Pattern**: AAA (Arrange-Act-Assert) structure [Source:
  docs/architecture/test-strategy-and-standards.md#Current Testing Stack]
- **TDD Approach**: Red-green-refactor cycle for learning Clean Architecture + DDD [Source:
  docs/architecture/test-strategy-and-standards.md#Testing Philosophy]
- **Coverage Goals**: 90%+ through TDD [Source:
  docs/architecture/test-strategy-and-standards.md#Testing Philosophy]

**Specific Testing Requirements for this Story:**

- No new tests required for this story since only creating directory structure and templates
- Verify all existing tests continue to pass after directory creation
- Template files should include example test structures following TDD patterns
- Integration verification through manual testing of existing endpoints

**Test Configuration (Maintain Current):**

- moduleNameMapper: "~/(.\*)$": "<rootDir>/src/$1" [Source:
  docs/architecture/test-strategy-and-standards.md#Test Configuration]
- testRegex: ".\*\\.spec\\.ts$" [Source: docs/architecture/test-strategy-and-standards.md#Test
  Configuration]
- testEnvironment: "node" [Source: docs/architecture/test-strategy-and-standards.md#Test
  Configuration]

## Change Log

| Date       | Version | Description                                                                           | Author             |
| ---------- | ------- | ------------------------------------------------------------------------------------- | ------------------ |
| 2025-08-01 | 1.0     | Initial story creation for Clean Architecture + DDD directory structure establishment | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

## QA Results

_This section will be populated by the QA agent after story completion_
