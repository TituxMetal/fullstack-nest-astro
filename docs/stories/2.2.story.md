---
epic: '2'
story_id: '2.2'
title: 'Refactor Auth Bounded Context to Clean Architecture'
status: 'Approved'
as_a: 'developer working with authentication features'
i_want: 'the auth module restructured using Clean Architecture patterns'
so_that:
  'business logic is separated from infrastructure concerns while maintaining all functionality'
acceptance_criteria:
  # Domain Layer
  - 'AC2.2.1: Create auth domain layer: auth/domain/entities/ (AuthUser.entity.ts with
    AuthUserEntity class), auth/domain/value-objects/ (Email.vo.ts with EmailValueObject,
    Password.vo.ts with PasswordValueObject), auth/domain/repositories/ (AuthUser.repository.ts with
    IAuthUserRepository interface), auth/domain/exceptions/ (InvalidCredentials.exception.ts), with
    index.ts barrel files in each folder'
  # Application Layer
  - 'AC2.2.2: Create auth application layer: auth/application/use-cases/ (Login.uc.ts with
    LoginUseCase, Register.uc.ts with RegisterUseCase, Logout.uc.ts with LogoutUseCase),
    auth/application/dtos/ (Login.dto.ts with LoginDto, Register.dto.ts with RegisterDto),
    auth/application/services/ (Auth.service.ts with AuthService), auth/application/mappers/
    (AuthUser.mapper.ts), with index.ts barrel files in each folder'
  # Infrastructure Layer
  - 'AC2.2.3: Create auth infrastructure layer: auth/infrastructure/repositories/
    (PrismaAuthUser.repository.ts implementing IAuthUserRepository), auth/infrastructure/services/
    (Jwt.service.ts, Password.service.ts), auth/infrastructure/controllers/ (Auth.controller.ts),
    auth/infrastructure/guards/ (JwtAuth.guard.ts), auth/infrastructure/mappers/
    (AuthUser.mapper.ts), with index.ts barrel files in each folder'
  # Module Integration
  - 'AC2.2.4: Create Auth.module.ts at root of auth folder, configure dependency injection with
    proper providers for repositories and use cases using NestJS patterns'
  # Migration Completion
  - 'AC2.2.5: Remove original auth/ directory after successful migration'
  # Integration Verification
  - 'IV2.2.1: POST /auth/login endpoint works identically'
  - 'IV2.2.2: POST /auth/register endpoint works identically'
  - 'IV2.2.3: POST /auth/logout endpoint works identically'
  - 'IV2.2.4: JWT authentication middleware functions normally'
  - 'IV2.2.5: All auth-related tests pass with updated imports'
---

## Tasks / Subtasks

- [ ] **Task 1: Create Auth Domain Layer** (AC: 2.2.1)

  - [ ] Create `auth/domain/entities/AuthUser.entity.ts` with `export class AuthUserEntity`
  - [ ] Create `auth/domain/value-objects/Email.vo.ts` with `export class EmailValueObject`
  - [ ] Create `auth/domain/value-objects/Password.vo.ts` with `export class PasswordValueObject`
  - [ ] Create `auth/domain/repositories/AuthUser.repository.ts` with
        `export interface IAuthUserRepository`
  - [ ] Create `auth/domain/exceptions/InvalidCredentials.exception.ts` with
        `export class InvalidCredentialsException`
  - [ ] Add `index.ts` barrel files in each domain sub-folder
  - [ ] Write unit tests (\*.spec.ts) for all domain components using TDD approach

- [ ] **Task 2: Create Auth Application Layer** (AC: 2.2.2)

  - [ ] Create `auth/application/use-cases/Login.uc.ts` with `export class LoginUseCase`
  - [ ] Create `auth/application/use-cases/Register.uc.ts` with `export class RegisterUseCase`
  - [ ] Create `auth/application/use-cases/Logout.uc.ts` with `export class LogoutUseCase`
  - [ ] Create `auth/application/dtos/Login.dto.ts` with `export class LoginDto`
  - [ ] Create `auth/application/dtos/Register.dto.ts` with `export class RegisterDto`
  - [ ] Create `auth/application/services/Auth.service.ts` with `export class AuthService`
  - [ ] Create `auth/application/mappers/AuthUser.mapper.ts` for DTO <> Domain mapping
  - [ ] Add `index.ts` barrel files in each application sub-folder
  - [ ] Write unit tests (\*.spec.ts) for all application components

- [ ] **Task 3: Create Auth Infrastructure Layer** (AC: 2.2.3)

  - [ ] Create `auth/infrastructure/repositories/PrismaAuthUser.repository.ts` with
        `export class PrismaAuthUserRepository implements IAuthUserRepository`
  - [ ] Create `auth/infrastructure/services/Jwt.service.ts` with `export class JwtService`
  - [ ] Create `auth/infrastructure/services/Password.service.ts` with
        `export class PasswordService`
  - [ ] Create `auth/infrastructure/controllers/Auth.controller.ts` with
        `export class AuthController`
  - [ ] Create `auth/infrastructure/guards/JwtAuth.guard.ts` with `export class JwtAuthGuard`
  - [ ] Create `auth/infrastructure/mappers/AuthUser.mapper.ts` for Persistence <> Domain mapping
  - [ ] Add `index.ts` barrel files in each infrastructure sub-folder
  - [ ] Write integration tests (\*.spec.ts) for infrastructure components

- [ ] **Task 4: Update Module Configuration** (AC: 2.2.4)

  - [ ] Create `auth/Auth.module.ts` with proper NestJS module configuration
  - [ ] Configure dependency injection: bind IAuthUserRepository to PrismaAuthUserRepository
  - [ ] Register all use cases as providers
  - [ ] Update imports to use barrel files (e.g.,
        `import { LoginUseCase } from '~/auth/application/use-cases'`)
  - [ ] Ensure proper provider registration following NestJS patterns

- [ ] **Task 5: Migration and Cleanup** (AC: 2.2.5)

  - [ ] Verify all existing auth functionality works with new structure
  - [ ] Run all existing tests to ensure no regressions
  - [ ] Remove original `src/auth/` directory preserving only new Clean Architecture structure
  - [ ] Update App.module.ts to import the new Auth.module
  - [ ] Update any remaining imports to use barrel files

- [ ] **Task 6: Integration Verification** (IV: 2.2.1-2.2.5)
  - [ ] Test POST /auth/login endpoint maintains exact same behavior
  - [ ] Test POST /auth/register endpoint maintains exact same behavior
  - [ ] Test POST /auth/logout endpoint maintains exact same behavior
  - [ ] Verify JWT authentication middleware continues to function normally
  - [ ] Ensure all auth-related tests pass with updated import paths

## Dev Notes

### Previous Story Insights

From Story 2.1, the Clean Architecture directory structure has been successfully established with
comprehensive templates and documentation. The foundation is ready for incremental module migration
with zero breaking changes approach. [Source: docs/stories/2.1.story.md#Dev Agent Record]

### Data Models and Database Schema

**Existing Prisma User Model (Maintain As-Is):**

- Fields for Auth Context: `id`, `email`, `username`, `hash`, `confirmed`, `blocked`, `createdAt`
- AuthUser entity will focus on authentication behavior around these fields
- Database schema remains unchanged - Clean Architecture layers built around existing data
- Both Auth and User contexts will use same Prisma User model with different domain interfaces
  [Source: docs/architecture/data-models.md#Bounded Context Field Mapping]

### API Specifications

**Auth Endpoints (Must Maintain Exact Contract):**

- POST /auth/register: Requires email, username, password (min 8 chars), optional firstName/lastName
- POST /auth/login: Requires emailOrUsername, password
- POST /auth/logout: No body required
- All endpoints must maintain exact HTTP status codes, headers (Set-Cookie), and response schemas
- JWT stored in HTTP-only cookie named 'auth_token' [Source:
  docs/architecture/rest-api-spec.md#paths]

### Clean Architecture Layer Structure

**Domain Layer (~/auth/domain/):**

- AuthUser.entity.ts: `export class AuthUserEntity` - Authentication behavior, account status
- Email.vo.ts: `export class EmailValueObject` - Email validation and formatting
- Password.vo.ts: `export class PasswordValueObject` - Password strength rules
- AuthUser.repository.ts: `export interface IAuthUserRepository` - Repository contract
- InvalidCredentials.exception.ts: `export class InvalidCredentialsException` - Domain exceptions
- All sub-folders have index.ts barrel files for clean imports

**Application Layer (~/auth/application/):**

- Login.uc.ts: `export class LoginUseCase` - Orchestrates login workflow
- Register.uc.ts: `export class RegisterUseCase` - Handles user registration
- Logout.uc.ts: `export class LogoutUseCase` - Manages logout process
- Login.dto.ts, Register.dto.ts: `export class LoginDto`, `export class RegisterDto`
- Auth.service.ts: `export class AuthService` - Application service orchestration
- AuthUser.mapper.ts: Maps between DTOs and domain entities
- All sub-folders have index.ts barrel files for clean imports

**Infrastructure Layer (~/auth/infrastructure/):**

- PrismaAuthUser.repository.ts:
  `export class PrismaAuthUserRepository implements IAuthUserRepository`
- Jwt.service.ts: `export class JwtService` - JWT token generation/validation
- Password.service.ts: `export class PasswordService` - Argon2 password hashing
- Auth.controller.ts: `export class AuthController` - HTTP endpoint handling
- JwtAuth.guard.ts: `export class JwtAuthGuard` - JWT authentication guard
- AuthUser.mapper.ts: Maps between persistence and domain models
- All sub-folders have index.ts barrel files for clean imports [Source:
  docs/architecture/source-tree.md#Target Project Structure]

### File Locations and Path Standards

**Directory Structure:**

```treeview
apps/backend/src/auth/
├── Auth.module.ts
├── domain/
│   ├── entities/
│   │   ├── index.ts
│   │   └── AuthUser.entity.ts
│   ├── exceptions/
│   │   ├── index.ts
│   │   └── InvalidCredentials.exception.ts
│   ├── value-objects/
│   │   ├── index.ts
│   │   ├── Email.vo.ts
│   │   └── Password.vo.ts
│   └── repositories/
│       ├── index.ts
│       └── AuthUser.repository.ts
├── application/
│   ├── use-cases/
│   │   ├── index.ts
│   │   ├── Login.uc.ts
│   │   ├── Register.uc.ts
│   │   └── Logout.uc.ts
│   ├── services/
│   │   ├── index.ts
│   │   └── Auth.service.ts
│   ├── dtos/
│   │   ├── index.ts
│   │   ├── Login.dto.ts
│   │   └── Register.dto.ts
│   └── mappers/
│       ├── index.ts
│       └── AuthUser.mapper.ts
└── infrastructure/
    ├── controllers/
    │   ├── index.ts
    │   └── Auth.controller.ts
    ├── repositories/
    │   ├── index.ts
    │   └── PrismaAuthUser.repository.ts
    ├── services/
    │   ├── index.ts
    │   ├── Jwt.service.ts
    │   └── Password.service.ts
    ├── guards/
    │   ├── index.ts
    │   └── JwtAuth.guard.ts
    └── mappers/
        ├── index.ts
        └── AuthUser.mapper.ts
```

**Import Path Standards:**

- Use ~/path alias with barrel imports:
  - `import { AuthUserEntity } from '~/auth/domain/entities'`
  - `import { LoginUseCase } from '~/auth/application/use-cases'`
  - `import { IAuthUserRepository } from '~/auth/domain/repositories'`
- All imports should use barrel files (index.ts) for cleaner imports
- Domain layer MUST NOT import infrastructure layer
- Application layer can import domain, NOT infrastructure
- Infrastructure layer can import both domain and application
- Every sub-folder must have an index.ts barrel file [Source:
  docs/architecture/coding-standards.md#Import Path Standards]

### Testing Requirements

**TDD Approach Required:**

- Write failing tests first (RED), minimal implementation (GREEN), refactor (REFACTOR)
- Unit tests for domain entities and value objects (85% of tests)
- Integration tests for infrastructure components (15% of tests)
- Use AAA pattern (Arrange-Act-Assert) in all tests
- Co-locate `*.spec.ts` files with source files

**Backend Test Configuration:**

- Jest 29.7.0 with moduleNameMapper for ~/paths
- testRegex: ".\*\\.spec\\.ts$"
- Node environment for backend tests
- Test coverage goal: 90%+ through TDD cycle [Source:
  docs/architecture/test-strategy-and-standards.md#Test Configuration]

### Technical Constraints

**Technology Stack:**

- NestJS 11.1.1 with dependency injection
- TypeScript 5.8.3+ with strict typing
- JWT authentication using @nestjs/jwt 11.0.0
- Argon2 0.43.0 for password hashing
- Prisma 6.8.2 for database operations
- SQLite database (existing schema unchanged)

**Monorepo Configuration:**

- Yarn 4.9.1 workspaces for dependency management
- Turborepo 2.5.3 for task orchestration and build caching
- **CRITICAL**: All commands must be run from project root using Turbo
- **NEVER** use npm commands - this is a Yarn workspace
- **NEVER** cd into backend directory - use Turbo from root
- Examples: `yarn turbo build --filter=backend`, `yarn turbo test --filter=backend`

**Naming Conventions:**

- Files: CamelCase + compact component suffix (Login.uc.ts, Email.vo.ts)
- Folders: kebab-case plural (use-cases/, value-objects/, dtos/)
- Classes: Full component type in name (export class LoginUseCase, export class EmailValueObject)
- Interfaces: 'I' prefix (export interface IAuthUserRepository)
- Domain Entities: AuthUser.entity.ts → export class AuthUserEntity
- Value Objects: Email.vo.ts → export class EmailValueObject
- Use Cases: Login.uc.ts → export class LoginUseCase
- DTOs: Login.dto.ts → export class LoginDto
- Services: Auth.service.ts → export class AuthService
- Every sub-folder MUST have index.ts barrel file [Source:
  docs/architecture/coding-standards.md#Naming Conventions]

### Project Structure Alignment

All file paths and component locations align with the established Clean Architecture structure from
Story 2.1. The auth/ module structure follows Clean Architecture with proper layer separation and
dependency rules enforced through import restrictions.

## Testing

### Testing Standards

**Framework and Location:**

- Jest 29.7.0 for backend testing
- Co-locate `*.spec.ts` files with source files
- Use ~/path alias in test imports

**Testing Patterns:**

- TDD approach: RED-GREEN-REFACTOR cycle
- AAA pattern: Arrange-Act-Assert structure
- 90%+ coverage through comprehensive unit tests
- Domain layer tests focus on business logic without infrastructure
- Integration tests verify infrastructure components work with domain

**Test Categories:**

- Unit tests (85%): Domain entities, value objects, use cases, application services
- Integration tests (15%): Repository implementations, adapters, controllers
- Mock external dependencies (Prisma, JWT, password hashing) in unit tests
- Use real implementations in integration tests

[Source: docs/architecture/test-strategy-and-standards.md]

## Change Log

| Date       | Version | Description                                                    | Author             |
| ---------- | ------- | -------------------------------------------------------------- | ------------------ |
| 2025-08-01 | 1.0     | Initial story creation for Auth Clean Architecture refactoring | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review of the completed story implementation will be added here_
