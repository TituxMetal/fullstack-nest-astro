---
epic: '2'
story_id: '2.5'
title: 'Infrastructure Foundation - Shared Clean Architecture Components'
status: 'Approved'
priority: 'CRITICAL'
as_a: 'developer working on any module in the application'
i_want: 'shared Clean Architecture components properly organized by layer'
so_that:
  'all modules can reuse common infrastructure, domain components while maintaining proper
  separation of concerns and DDD patterns'
acceptance_criteria:
  # Shared Database Infrastructure
  - 'AC2.5.1: Move Prisma infrastructure to shared/infrastructure/database/ (PrismaService,
    PrismaModule), create shared/infrastructure/database/Database.module.ts and update all existing
    imports to use shared location'
  # Shared Infrastructure Components
  - 'AC2.5.2: Move decorators to shared/infrastructure/decorators/ with proper barrel exports and
    update all imports across codebase'
  # Shared Infrastructure Interceptors
  - 'AC2.5.3: Move interceptors to shared/infrastructure/interceptors/ with proper barrel exports
    and update all imports across codebase'
  # Shared Domain Types and Validation
  - 'AC2.5.4: Move domain types to shared/domain/types/ and domain validation to
    shared/domain/validation/ with proper Clean Architecture separation'
  # Shared Infrastructure Types and Validation
  - 'AC2.5.5: Move infrastructure types to shared/infrastructure/types/ and infrastructure
    validation to shared/infrastructure/validation/ maintaining layer separation'
  # Import Updates and Verification
  - 'AC2.5.6: Update all imports across codebase to use shared locations and verify all existing
    functionality works identically with comprehensive test coverage'
  # Integration Verification
  - 'IV2.5.1: All existing endpoints work identically with shared components'
  - 'IV2.5.2: All existing tests pass with updated imports'
  - 'IV2.5.3: Database operations maintain same performance characteristics'
  - 'IV2.5.4: Shared components follow Clean Architecture and DDD principles'
  - 'IV2.5.5: No functionality changes - only code organization improvements'
---

## Tasks / Subtasks

- [ ] **Task 1: Move Database Infrastructure to Shared** (AC: 2.5.1)
  - [ ] Create `shared/infrastructure/database/` directory structure
  - [ ] Move `src/prisma/prisma.service.ts` to `shared/infrastructure/database/Prisma.service.ts`
  - [ ] Move `src/prisma/prisma.module.ts` to `shared/infrastructure/database/Prisma.module.ts`
  - [ ] Create `shared/infrastructure/database/Database.module.ts` as main export
  - [ ] Create `shared/infrastructure/database/index.ts` barrel file
  - [ ] Update imports across codebase to use shared database location
  - [ ] Remove original `src/prisma/` directory after migration
  - [ ] Add tests for database module functionality

- [ ] **Task 2: Move Shared Decorators** (AC: 2.5.2)
  - [ ] Create `shared/infrastructure/decorators/` directory
  - [ ] Move existing decorators to shared location with proper organization
  - [ ] Create `shared/infrastructure/decorators/index.ts` barrel file
  - [ ] Update all imports across codebase to use shared decorators
  - [ ] Add tests for decorator functionality

- [ ] **Task 3: Move Shared Interceptors** (AC: 2.5.3)
  - [ ] Create `shared/infrastructure/interceptors/` directory
  - [ ] Move existing interceptors to shared location
  - [ ] Create `shared/infrastructure/interceptors/index.ts` barrel file
  - [ ] Update all imports across codebase to use shared interceptors
  - [ ] Add tests for interceptor functionality

- [ ] **Task 4: Organize Shared Domain Components** (AC: 2.5.4)
  - [ ] Create `shared/domain/types/` for domain-specific types
  - [ ] Create `shared/domain/validation/` for domain validation rules
  - [ ] Move appropriate domain types to shared domain layer
  - [ ] Move domain validation logic to shared domain layer
  - [ ] Create barrel files: `shared/domain/types/index.ts` and `shared/domain/validation/index.ts`
  - [ ] Update imports to use shared domain components
  - [ ] Add comprehensive tests for shared domain components

- [ ] **Task 5: Organize Shared Infrastructure Components** (AC: 2.5.5)
  - [ ] Create `shared/infrastructure/types/` for infrastructure-specific types
  - [ ] Create `shared/infrastructure/validation/` for infrastructure validation
  - [ ] Move appropriate infrastructure types to shared infrastructure layer
  - [ ] Move infrastructure validation logic to shared infrastructure layer
  - [ ] Create barrel files: `shared/infrastructure/types/index.ts` and
        `shared/infrastructure/validation/index.ts`
  - [ ] Update imports to use shared infrastructure components
  - [ ] Add tests for shared infrastructure components

- [ ] **Task 6: Update All Imports and Verify Functionality** (AC: 2.5.6)
  - [ ] Update `app.module.ts` to use shared Database.module
  - [ ] Search and update all imports of moved components across entire codebase
  - [ ] Verify all modules resolve dependencies correctly
  - [ ] Run build to ensure no import errors
  - [ ] Run all existing tests to verify no functionality changes
  - [ ] Add integration tests to verify shared components work correctly
  - [ ] Clean up any unused import paths or references

- [ ] **Task 7: Final Integration Verification** (IV: 2.5.1-2.5.5)
  - [ ] Test all existing endpoints work identically
  - [ ] Verify all existing tests pass with updated imports
  - [ ] Check database operations maintain same performance
  - [ ] Ensure shared components follow Clean Architecture principles
  - [ ] Verify DDD patterns are properly maintained
  - [ ] Run full test suite to ensure zero functionality changes
  - [ ] Document shared component usage patterns

## Dev Notes

### Architectural Foundation Rationale

From Story 2.2 QA review, the following critical architectural debt was identified:

**"Missing shared components"** and **"Infrastructure concerns scattered across modules"**

This Infrastructure Foundation story addresses these core issues by establishing:

1. **Shared Clean Architecture Structure**: Properly organizes shared components by architectural
   layer
2. **Centralized Infrastructure**: Moves database, decorators, interceptors to shared location
3. **Domain/Infrastructure Separation**: Organizes types and validation by appropriate architectural
   layer
4. **DDD Pattern Support**: Enables proper Domain Driven Design with shared domain components

[Source: docs/stories/2.2.story.md#QA Results - Broader Architectural Analysis]

### Clean Architecture Alignment

**Before - Scattered Infrastructure:**

```treeview
src/
├── prisma/
│   ├── prisma.service.ts (isolated)
│   └── prisma.module.ts
├── auth/
│   └── [duplicated decorators, types, validation]
├── users/
│   └── [duplicated decorators, types, validation]
```

**After - Clean Architecture Shared Structure:**

```treeview
shared/
├── domain/
│   ├── types/
│   ├── validation/
│   └── index.ts
└── infrastructure/
    ├── database/
    │   ├── Database.module.ts
    │   ├── Prisma.service.ts
    │   └── index.ts
    ├── decorators/
    ├── interceptors/
    ├── types/
    ├── validation/
    └── index.ts
```

### Shared Components Benefits

**Clean Architecture Organization:**

- Proper separation of domain and infrastructure concerns
- Eliminates code duplication across modules
- Centralizes common functionality in appropriate layers
- Enables consistent patterns across the application

**Domain Driven Design Support:**

- Shared domain types and validation in domain layer
- Infrastructure concerns properly separated
- Consistent domain modeling across modules
- Better testability with shared components

**Infrastructure Consolidation:**

- Single database module shared across all features
- Centralized decorators and interceptors
- Consistent infrastructure patterns
- Easier maintenance and updates

### Current Infrastructure Analysis

**Existing Prisma Usage:**

- `apps/api/src/prisma/prisma.service.ts` - Core database connection service
- `apps/api/src/prisma/prisma.module.ts` - Module configuration
- `apps/api/src/auth/infrastructure/repositories/PrismaAuthUser.repository.ts` - Direct usage

**Components to Move:**

- `apps/api/src/prisma/` → `apps/api/src/shared/infrastructure/database/`
- Scattered decorators → `apps/api/src/shared/infrastructure/decorators/`
- Scattered interceptors → `apps/api/src/shared/infrastructure/interceptors/`
- Domain types → `apps/api/src/shared/domain/types/`
- Infrastructure types → `apps/api/src/shared/infrastructure/types/`

### Target Architecture Design

**Shared Database Infrastructure:**

```typescript
// Shared database module - infrastructure layer
@Module({
  providers: [PrismaService],
  exports: [PrismaService]
})
export class DatabaseModule {}

// Usage in feature modules
@Module({
  imports: [DatabaseModule],
  providers: [AuthUserRepository],
  exports: [AuthUserRepository]
})
export class AuthModule {}
```

**Shared Components Pattern:**

```typescript
// Domain types in shared/domain/types
export interface UserDomainType {
  id: string
  email: EmailValueObject
  username: string
}

// Infrastructure types in shared/infrastructure/types
export interface DatabaseConfig {
  url: string
  timeout: number
}

// Shared decorators in shared/infrastructure/decorators
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  // Common logging logic
}
```

### Shared Components Organization

**Domain Layer Components:**

```typescript
// shared/domain/types/User.types.ts
export interface UserDomainProps {
  id: string
  email: EmailValueObject
  username: string
}

// shared/domain/validation/Email.validation.ts
export const validateEmail = (email: string): boolean => {
  // Domain-specific email validation rules
}
```

**Infrastructure Layer Components:**

```typescript
// shared/infrastructure/database/Database.module.ts
@Module({
  providers: [PrismaService],
  exports: [PrismaService]
})
export class DatabaseModule {}

// shared/infrastructure/decorators/Auth.decorator.ts
export const RequireAuth = (): MethodDecorator => {
  // Common authentication decorator
}

// shared/infrastructure/interceptors/Logging.interceptor.ts
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  // Common logging functionality
}
```

### Migration Strategy

**Zero-Downtime Approach:**

1. **Create Shared Directories**: Build shared folder structure following Clean Architecture
2. **Move Database Infrastructure**: Move Prisma services to shared/infrastructure/database
3. **Move Infrastructure Components**: Move decorators, interceptors to shared/infrastructure
4. **Organize Domain Components**: Move domain types and validation to shared/domain
5. **Update All Imports**: Change import paths across entire codebase
6. **Verify Functionality**: Ensure all existing behavior works unchanged
7. **Clean Up**: Remove old scattered components after verification

**Critical Preservation Requirements:**

- All existing functionality must work identically (zero behavior changes)
- Database operations must maintain same performance
- All existing tests must pass without modification
- Import paths updated but functionality preserved
- Clean Architecture principles properly followed

### File Locations and Path Standards

**New Import Paths:**

- Database Service: `import { PrismaService } from '~/shared/infrastructure/database'`
- Database Module: `import { DatabaseModule } from '~/shared/infrastructure/database'`
- Shared Decorators: `import { RequireAuth } from '~/shared/infrastructure/decorators'`
- Shared Interceptors: `import { LoggingInterceptor } from '~/shared/infrastructure/interceptors'`
- Domain Types: `import { UserDomainProps } from '~/shared/domain/types'`
- Infrastructure Types: `import { DatabaseConfig } from '~/shared/infrastructure/types'`

**Directory Structure After Implementation:**

```treeview
apps/api/src/
├── shared/
│   ├── domain/
│   │   ├── types/
│   │   │   ├── User.types.ts
│   │   │   └── index.ts
│   │   ├── validation/
│   │   │   ├── Email.validation.ts
│   │   │   └── index.ts
│   │   └── index.ts
│   └── infrastructure/
│       ├── database/
│       │   ├── Database.module.ts
│       │   ├── Prisma.service.ts
│       │   └── index.ts
│       ├── decorators/
│       │   ├── Auth.decorator.ts
│       │   └── index.ts
│       ├── interceptors/
│       │   ├── Logging.interceptor.ts
│       │   └── index.ts
│       ├── types/
│       │   ├── Database.types.ts
│       │   └── index.ts
│       ├── validation/
│       │   ├── Request.validation.ts
│       │   └── index.ts
│       └── index.ts
├── auth/
│   └── infrastructure/
│       └── repositories/
│           └── PrismaAuthUser.repository.ts (uses shared database)
└── [no standalone prisma/ directory]
```

### Performance and Scalability Considerations

**Shared Component Performance:**

- Single database module eliminates duplicate Prisma instances
- Centralized decorators and interceptors reduce overhead
- Shared validation reduces code duplication and improves performance
- Better tree-shaking with proper barrel exports

**Database Connection Management:**

- Shared PrismaService ensures single connection pool across all modules
- Centralized database configuration and management
- Consistent database patterns across the application
- Better resource utilization with shared infrastructure

### Risk Assessment

**Risk Level: LOW** - Simple reorganization with zero functionality changes

**Mitigation Strategies:**

1. **Incremental Migration**: Move components one category at a time
2. **Comprehensive Testing**: Run existing tests after each migration step
3. **Simple Rollback**: Easy to revert since only file locations change
4. **Build Verification**: Ensure TypeScript compilation succeeds at each step

**Components Affected:**

- All modules importing PrismaService or PrismaModule
- Any modules using shared decorators or interceptors
- Modules with duplicated types or validation logic
- Import statements across the entire codebase

### Testing Strategy

**Test Categories:**

- Unit tests (80%): Shared components functionality testing
- Integration tests (15%): Database module and shared infrastructure testing
- Migration verification tests (5%): Ensure identical behavior after reorganization

**Testing Focus Areas:**

- Shared database module functionality
- Decorator and interceptor behavior
- Domain and infrastructure type validation
- Import path resolution and barrel exports
- Error handling consistency

**Performance Testing:**

- Database connection efficiency with shared infrastructure
- Decorator and interceptor overhead
- Bundle size impact of shared components
- Build time with new import structure

## Testing

### Testing Standards

**Framework and Location:**

- Jest 29.7.0 for backend testing
- Co-locate `*.spec.ts` files with source files
- Use ~/path alias in test imports

**Testing Patterns:**

- TDD approach: RED-GREEN-REFACTOR cycle
- AAA pattern: Arrange-Act-Assert structure
- 90%+ coverage through comprehensive unit tests
- Interface contract testing for repository abstractions
- Integration testing for infrastructure components

**Test Categories:**

- Unit tests (70%): Repository interfaces, base implementations, factory patterns
- Integration tests (25%): Database connectivity, transaction management, repository operations
- Migration verification tests (5%): Ensure existing functionality preservation

### Infrastructure Foundation Testing

**Repository Pattern Testing:**

- Generic interface contract validation
- Base implementation behavior verification
- Mapping function correctness and edge cases
- Error handling and exception scenarios

**Transaction Management Testing:**

- Unit of work pattern transaction boundaries
- Commit and rollback scenario testing
- Nested transaction handling
- Concurrent operation testing

**Factory Pattern Testing:**

- Repository registration and discovery
- Dynamic repository creation
- Dependency injection integration
- Lifecycle management verification

## Change Log

| Date       | Version | Description                                                                  | Author                  |
| ---------- | ------- | ---------------------------------------------------------------------------- | ----------------------- |
| 2025-09-02 | 1.0     | Initial story creation for Infrastructure Foundation and Repository Patterns | Claude (PM & Architect) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled during implementation_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

**Files to be Created:**

Shared Domain Layer:

- `apps/api/src/shared/domain/types/[DomainType].types.ts`
- `apps/api/src/shared/domain/validation/[DomainValidation].validation.ts`
- `apps/api/src/shared/domain/types/index.ts`
- `apps/api/src/shared/domain/validation/index.ts`
- `apps/api/src/shared/domain/index.ts`

Shared Infrastructure Layer:

- `apps/api/src/shared/infrastructure/database/Database.module.ts`
- `apps/api/src/shared/infrastructure/decorators/[Decorator].decorator.ts`
- `apps/api/src/shared/infrastructure/interceptors/[Interceptor].interceptor.ts`
- `apps/api/src/shared/infrastructure/types/[InfraType].types.ts`
- `apps/api/src/shared/infrastructure/validation/[InfraValidation].validation.ts`
- `apps/api/src/shared/infrastructure/database/index.ts`
- `apps/api/src/shared/infrastructure/decorators/index.ts`
- `apps/api/src/shared/infrastructure/interceptors/index.ts`
- `apps/api/src/shared/infrastructure/types/index.ts`
- `apps/api/src/shared/infrastructure/validation/index.ts`
- `apps/api/src/shared/infrastructure/index.ts`

Test Files:

- `apps/api/src/shared/domain/types/[DomainType].types.spec.ts`
- `apps/api/src/shared/domain/validation/[DomainValidation].validation.spec.ts`
- `apps/api/src/shared/infrastructure/database/Database.module.spec.ts`
- `apps/api/src/shared/infrastructure/decorators/[Decorator].decorator.spec.ts`
- `apps/api/src/shared/infrastructure/interceptors/[Interceptor].interceptor.spec.ts`

**Files to be Modified:**

- `apps/api/src/app.module.ts` - Import DatabaseModule from shared location
- `apps/api/src/auth/Auth.module.ts` - Update imports to use shared components
- `apps/api/src/users/Users.module.ts` - Update imports to use shared components
- `apps/api/src/auth/infrastructure/repositories/PrismaAuthUser.repository.ts` - Update database
  imports
- All files importing moved decorators, interceptors, types, or validation
- All test files with updated import paths

**Files to be Moved:**

- `apps/api/src/prisma/prisma.service.ts` →
  `apps/api/src/shared/infrastructure/database/Prisma.service.ts`
- `apps/api/src/prisma/prisma.module.ts` →
  `apps/api/src/shared/infrastructure/database/Prisma.module.ts`
- Scattered decorators → `apps/api/src/shared/infrastructure/decorators/`
- Scattered interceptors → `apps/api/src/shared/infrastructure/interceptors/`
- Domain-related types → `apps/api/src/shared/domain/types/`
- Infrastructure-related types → `apps/api/src/shared/infrastructure/types/`
- Domain validation logic → `apps/api/src/shared/domain/validation/`
- Infrastructure validation logic → `apps/api/src/shared/infrastructure/validation/`

**Files to be Deleted:**

- `apps/api/src/prisma/` (entire directory after successful migration)
- Any duplicate decorator, interceptor, type, or validation files after consolidation
- Old import references after updating to shared locations

## QA Results

_This section will be populated by the QA agent during review_

### Review Date

_To be filled during review_

### Reviewed By

_To be filled during review_

### Code Quality Assessment

_To be filled during review_

### Refactoring Performed

_To be filled during review_

### Compliance Check

_To be filled during review_

### Requirements Traceability

_To be filled during review_

### Recommended Status

_To be filled during review_
