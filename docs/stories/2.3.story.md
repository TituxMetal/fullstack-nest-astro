---
epic: '2'
story_id: '2.3'
title: 'Refactor Users Bounded Context to Clean Architecture'
status: 'Approved'
as_a: 'developer working with user profile features'
i_want: 'the users module restructured using Clean Architecture patterns'
so_that:
  'users profile business logic is separated from infrastructure concerns while maintaining all
  functionality'
acceptance_criteria:
  # Domain Layer
  - 'AC2.3.1: Create users domain layer: users/domain/entities/ (User.entity.ts with UserEntity
    class), users/domain/value-objects/ (UserId.vo.ts with UserIdValueObject, Username.vo.ts with
    UsernameValueObject, Name.vo.ts with NameValueObject), users/domain/repositories/
    (User.repository.ts with IUserRepository interface), users/domain/exceptions/
    (UserNotFound.exception.ts, InvalidUser.exception.ts), with index.ts barrel files in each folder'
  # Application Layer
  - 'AC2.3.2: Create users application layer: users/application/use-cases/ (GetUserProfile.uc.ts with
    GetUserProfileUseCase, UpdateUserProfile.uc.ts with UpdateUserProfileUseCase,
    DeleteUserAccount.uc.ts with DeleteUserAccountUseCase, CreateUser.uc.ts with CreateUserUseCase,
    GetAllUsers.uc.ts with GetAllUsersUseCase), users/application/dtos/ (GetUserProfile.dto.ts,
    UpdateUserProfile.dto.ts, CreateUser.dto.ts with DTOs), users/application/services/
    (User.service.ts with UserService), users/application/mappers/ (User.mapper.ts), with index.ts
    barrel files in each folder'
  # Infrastructure Layer
  - 'AC2.3.3: Create users infrastructure layer: users/infrastructure/repositories/
    (PrismaUser.repository.ts implementing IUserRepository), users/infrastructure/controllers/
    (User.controller.ts), users/infrastructure/mappers/ (User.mapper.ts), with index.ts barrel files
    in each folder'
  # Module Integration
  - 'AC2.3.4: Create Users.module.ts at root of users folder, configure dependency injection with
    proper providers for repositories and use cases using NestJS patterns'
  # Migration Completion
  - 'AC2.3.5: Remove original user/ directory structure after successful migration, preserving only
    new Clean Architecture structure in users/ directory'
  # Integration Verification
  - 'IV2.3.1: GET /users/me endpoint works identically'
  - 'IV2.3.2: PATCH /users/me endpoint works identically'
  - 'IV2.3.3: DELETE /users/me endpoint works identically'
  - 'IV2.3.4: POST /users endpoint works identically'
  - 'IV2.3.5: GET /users endpoint works identically'
  - 'IV2.3.6: All user-related tests pass with updated imports'
---

## Tasks / Subtasks

- [ ] **Task 1: Create Users Domain Layer** (AC: 2.3.1)

  - [ ] Create `users/domain/entities/User.entity.ts` with `export class UserEntity`
  - [ ] Create `users/domain/value-objects/UserId.vo.ts` with `export class UserIdValueObject`
  - [ ] Create `users/domain/value-objects/Username.vo.ts` with `export class UsernameValueObject`
  - [ ] Create `users/domain/value-objects/Name.vo.ts` with `export class NameValueObject`
  - [ ] Create `users/domain/repositories/User.repository.ts` with `export interface IUserRepository`
  - [ ] Create `users/domain/exceptions/UserNotFound.exception.ts` with
        `export class UserNotFoundException`
  - [ ] Create `users/domain/exceptions/InvalidUser.exception.ts` with
        `export class InvalidUserException`
  - [ ] Add `index.ts` barrel files in each domain sub-folder
  - [ ] Write unit tests (\*.spec.ts) for all domain components using TDD approach

- [ ] **Task 2: Create Users Application Layer** (AC: 2.3.2)

  - [ ] Create `users/application/use-cases/GetUserProfile.uc.ts` with
        `export class GetUserProfileUseCase`
  - [ ] Create `users/application/use-cases/UpdateUserProfile.uc.ts` with
        `export class UpdateUserProfileUseCase`
  - [ ] Create `users/application/use-cases/DeleteUserAccount.uc.ts` with
        `export class DeleteUserAccountUseCase`
  - [ ] Create `users/application/use-cases/CreateUser.uc.ts` with `export class CreateUserUseCase`
  - [ ] Create `users/application/use-cases/GetAllUsers.uc.ts` with `export class GetAllUsersUseCase`
  - [ ] Create `users/application/dtos/GetUserProfile.dto.ts` with `export class GetUserProfileDto`
  - [ ] Create `users/application/dtos/UpdateUserProfile.dto.ts` with
        `export class UpdateUserProfileDto`
  - [ ] Create `users/application/dtos/CreateUser.dto.ts` with `export class CreateUserDto`
  - [ ] Create `users/application/services/User.service.ts` with `export class UserService`
  - [ ] Create `users/application/mappers/User.mapper.ts` for DTO <> Domain mapping
  - [ ] Add `index.ts` barrel files in each application sub-folder
  - [ ] Write unit tests (\*.spec.ts) for all application components

- [ ] **Task 3: Create Users Infrastructure Layer** (AC: 2.3.3)

  - [ ] Create `users/infrastructure/repositories/PrismaUser.repository.ts` with
        `export class PrismaUserRepository implements IUserRepository`
  - [ ] Create `users/infrastructure/controllers/User.controller.ts` with
        `export class UserController`
  - [ ] Create `users/infrastructure/mappers/User.mapper.ts` for Persistence <> Domain mapping
  - [ ] Add `index.ts` barrel files in each infrastructure sub-folder
  - [ ] Write integration tests (\*.spec.ts) for infrastructure components

- [ ] **Task 4: Update Module Configuration** (AC: 2.3.4)

  - [ ] Create `users/Users.module.ts` with proper NestJS module configuration
  - [ ] Configure dependency injection: bind IUserRepository to PrismaUserRepository
  - [ ] Register all use cases as providers
  - [ ] Update imports to use barrel files (e.g.,
        `import { GetUserProfileUseCase } from '~/users/application/use-cases'`)
  - [ ] Ensure proper provider registration following NestJS patterns

- [ ] **Task 5: Migration and Cleanup** (AC: 2.3.5)

  - [ ] Verify all existing user functionality works with new structure
  - [ ] Run all existing tests to ensure no regressions
  - [ ] Remove original `src/user/` directory preserving only new Clean Architecture structure
  - [ ] Update App.module.ts to import the new Users.module
  - [ ] Update any remaining imports to use barrel files

- [ ] **Task 6: Integration Verification** (IV: 2.3.1-2.3.6)
  - [ ] Test GET /users/me endpoint maintains exact same behavior
  - [ ] Test PATCH /users/me endpoint maintains exact same behavior
  - [ ] Test DELETE /users/me endpoint maintains exact same behavior
  - [ ] Test POST /users endpoint maintains exact same behavior
  - [ ] Test GET /users endpoint maintains exact same behavior
  - [ ] Ensure all user-related tests pass with updated import paths

## Dev Notes

### Previous Story Insights

Story 2.2 Auth refactoring was highly successful, providing an excellent template for Clean
Architecture implementation. Key patterns to replicate:

- Domain entities with proper encapsulation (AuthUserEntity)
- Value objects for key concepts (EmailValueObject, PasswordValueObject)
- Repository interfaces with dependency inversion (IAuthUserRepository)
- Use cases with single responsibility (LoginUseCase, RegisterUseCase)
- Infrastructure adapters (PrismaAuthUserRepository, AuthController)
- Comprehensive barrel files for clean imports

[Source: docs/stories/2.2.story.md#Dev Agent Record]

### Data Models and Database Schema

**Existing Prisma User Model (Maintain As-Is):**

- Fields for User Context: `id`, `email`, `username`, `firstName`, `lastName`, `confirmed`,
  `createdAt`, `updatedAt`
- User entity will focus on profile management behavior around these fields
- Database schema remains unchanged - Clean Architecture layers built around existing data
- Auth module will continue using User model for authentication concerns via repository pattern
  [Source: docs/architecture/data-models.md#Bounded Context Field Mapping]

### API Specifications

**User Endpoints (Must Maintain Exact Contract):**

- GET /users/me: Requires authentication, returns current user profile
- PATCH /users/me: Requires authentication, updates profile (username, firstName, lastName)
- DELETE /users/me: Requires authentication, soft-deletes user account
- POST /users: Admin endpoint for creating users (email, username, password, optional names)
- GET /users: Admin endpoint for listing all users
- All endpoints must maintain exact HTTP status codes, authentication guards, and response schemas
- Uses JwtAuthGuard from Auth module for authentication [Source:
  docs/architecture/rest-api-spec.md#paths]

### Clean Architecture Layer Structure

**Domain Layer (~/user/domain/):**

- User.entity.ts: `export class UserEntity` - User profile behavior, account management
- UserId.vo.ts: `export class UserIdValueObject` - Unique identifier validation
- Username.vo.ts: `export class UsernameValueObject` - Username rules and validation
- Name.vo.ts: `export class NameValueObject` - First/last name validation
- User.repository.ts: `export interface IUserRepository` - Repository contract for user operations
- UserNotFound.exception.ts: `export class UserNotFoundException` - Domain exception
- InvalidUser.exception.ts: `export class InvalidUserException` - Domain validation exception
- All sub-folders have index.ts barrel files for clean imports

**Application Layer (~/user/application/):**

- GetUserProfile.uc.ts: `export class GetUserProfileUseCase` - Retrieve user profile
- UpdateUserProfile.uc.ts: `export class UpdateUserProfileUseCase` - Update profile data
- DeleteUserAccount.uc.ts: `export class DeleteUserAccountUseCase` - Account deletion
- CreateUser.uc.ts: `export class CreateUserUseCase` - Admin user creation
- GetAllUsers.uc.ts: `export class GetAllUsersUseCase` - Admin user listing
- GetUserProfile.dto.ts, UpdateUserProfile.dto.ts, CreateUser.dto.ts: Request/Response DTOs
- User.service.ts: `export class UserService` - Application service orchestration
- User.mapper.ts: Maps between DTOs and domain entities
- All sub-folders have index.ts barrel files for clean imports

**Infrastructure Layer (~/user/infrastructure/):**

- PrismaUser.repository.ts: `export class PrismaUserRepository implements IUserRepository`
- User.controller.ts: `export class UserController` - HTTP endpoint handling
- User.mapper.ts: Maps between persistence and domain models
- All sub-folders have index.ts barrel files for clean imports [Source:
  docs/architecture/source-tree.md#Target Project Structure]

### File Locations and Path Standards

**Directory Structure:**

```treeview
apps/backend/src/users/
├── Users.module.ts
├── domain/
│   ├── entities/
│   │   ├── index.ts
│   │   └── User.entity.ts
│   ├── exceptions/
│   │   ├── index.ts
│   │   ├── UserNotFound.exception.ts
│   │   └── InvalidUser.exception.ts
│   ├── value-objects/
│   │   ├── index.ts
│   │   ├── UserId.vo.ts
│   │   ├── Username.vo.ts
│   │   └── Name.vo.ts
│   └── repositories/
│       ├── index.ts
│       └── User.repository.ts
├── application/
│   ├── use-cases/
│   │   ├── index.ts
│   │   ├── GetUserProfile.uc.ts
│   │   ├── UpdateUserProfile.uc.ts
│   │   ├── DeleteUserAccount.uc.ts
│   │   ├── CreateUser.uc.ts
│   │   └── GetAllUsers.uc.ts
│   ├── services/
│   │   ├── index.ts
│   │   └── User.service.ts
│   ├── dtos/
│   │   ├── index.ts
│   │   ├── GetUserProfile.dto.ts
│   │   ├── UpdateUserProfile.dto.ts
│   │   └── CreateUser.dto.ts
│   └── mappers/
│       ├── index.ts
│       └── User.mapper.ts
└── infrastructure/
    ├── controllers/
    │   ├── index.ts
    │   └── User.controller.ts
    ├── repositories/
    │   ├── index.ts
    │   └── PrismaUser.repository.ts
    └── mappers/
        ├── index.ts
        └── User.mapper.ts
```

**Import Path Standards:**

- Use ~/path alias with barrel imports:
  - `import { UserEntity } from '~/users/domain/entities'`
  - `import { GetUserProfileUseCase } from '~/users/application/use-cases'`
  - `import { IUserRepository } from '~/users/domain/repositories'`
- All imports should use barrel files (index.ts) for cleaner imports
- Domain layer MUST NOT import infrastructure layer
- Application layer can import domain, NOT infrastructure
- Infrastructure layer can import both domain and application
- Every sub-folder must have an index.ts barrel file [Source:
  docs/architecture/coding-standards.md#Import Path Standards]

### Testing Requirements

**TDD Approach Required:**

- Write failing tests first (RED), minimal implementation (GREEN), refactor (REFACTOR)
- Unit tests for domain entities and value objects (85% of tests)
- Integration tests for infrastructure components (15% of tests)
- Use AAA pattern (Arrange-Act-Assert) in all tests
- Co-locate `*.spec.ts` files with source files

**Backend Test Configuration:**

- Jest 29.7.0 with moduleNameMapper for ~/paths
- testRegex: ".\*\\.spec\\.ts$"
- Node environment for backend tests
- Test coverage goal: 90%+ through TDD cycle [Source:
  docs/architecture/test-strategy-and-standards.md#Test Configuration]

### Technical Constraints

**Technology Stack:**

- NestJS 11.1.1 with dependency injection
- TypeScript 5.8.3+ with strict typing
- Prisma 6.8.2 for database operations
- SQLite database (existing schema unchanged)

**Monorepo Configuration:**

- Yarn 4.9.1 workspaces for dependency management
- Turborepo 2.5.3 for task orchestration and build caching
- **CRITICAL**: All commands must be run from project root using Turbo
- **NEVER** use npm commands - this is a Yarn workspace
- **NEVER** cd into backend directory - use Turbo from root
- Examples: `yarn turbo build --filter=backend`, `yarn turbo test --filter=backend`

**Naming Conventions:**

- Files: CamelCase + compact component suffix (GetUserProfile.uc.ts, Username.vo.ts)
- Folders: kebab-case plural (use-cases/, value-objects/, dtos/)
- Classes: Full component type in name (export class GetUserProfileUseCase, export class
  UsernameValueObject)
- Interfaces: 'I' prefix (export interface IUserRepository)
- Domain Entities: User.entity.ts → export class UserEntity
- Value Objects: Username.vo.ts → export class UsernameValueObject
- Use Cases: GetUserProfile.uc.ts → export class GetUserProfileUseCase
- DTOs: GetUserProfile.dto.ts → export class GetUserProfileDto
- Services: User.service.ts → export class UserService
- Every sub-folder MUST have index.ts barrel file [Source:
  docs/architecture/coding-standards.md#Naming Conventions]

### Bounded Context Separation

**Critical Separation from Auth Context:**

- User module focuses on profile management, NOT authentication
- Remove password hashing logic from UserService (belongs in Auth infrastructure)
- Auth module handles login/register/logout via AuthUser bounded context
- User module handles profile CRUD via User bounded context
- Both contexts may use same Prisma User model with different repository interfaces
- Clear API boundary: /auth/\* vs /users/\* endpoints
- NO direct imports between User and Auth domains - only infrastructure can coordinate

### Migration Strategy

**Incremental Refactoring Approach:**

1. **Domain First**: Create domain entities and value objects with comprehensive tests
2. **Application Layer**: Build use cases that orchestrate domain operations
3. **Infrastructure**: Implement repository and controller adapters
4. **Module Wiring**: Configure dependency injection with proper abstractions
5. **Gradual Cutover**: Update imports progressively, maintaining backward compatibility
6. **Cleanup**: Remove old structure only after all tests pass

This approach minimizes risk and ensures zero downtime during refactoring.

## Testing

### Testing Standards

**Framework and Location:**

- Jest 29.7.0 for backend testing
- Co-locate `*.spec.ts` files with source files
- Use ~/path alias in test imports

**Testing Patterns:**

- TDD approach: RED-GREEN-REFACTOR cycle
- AAA pattern: Arrange-Act-Assert structure
- 90%+ coverage through comprehensive unit tests
- Domain layer tests focus on business logic without infrastructure
- Integration tests verify infrastructure components work with domain

**Test Categories:**

- Unit tests (85%): Domain entities, value objects, use cases, application services
- Integration tests (15%): Repository implementations, controllers
- Mock external dependencies (Prisma) in unit tests
- Use real implementations in integration tests

[Source: docs/architecture/test-strategy-and-standards.md]

## Change Log

| Date       | Version | Description                                                    | Author                |
| ---------- | ------- | -------------------------------------------------------------- | --------------------- |
| 2025-09-02 | 1.0     | Initial story creation for User Clean Architecture refactoring | Claude (PM & Crafter) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled during implementation_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

**Files to be Created:**

Domain Layer:

- `apps/backend/src/users/domain/entities/User.entity.ts`
- `apps/backend/src/users/domain/entities/User.entity.spec.ts`
- `apps/backend/src/users/domain/entities/index.ts`
- `apps/backend/src/users/domain/value-objects/UserId.vo.ts`
- `apps/backend/src/users/domain/value-objects/UserId.vo.spec.ts`
- `apps/backend/src/users/domain/value-objects/Username.vo.ts`
- `apps/backend/src/users/domain/value-objects/Username.vo.spec.ts`
- `apps/backend/src/users/domain/value-objects/Name.vo.ts`
- `apps/backend/src/users/domain/value-objects/Name.vo.spec.ts`
- `apps/backend/src/users/domain/value-objects/index.ts`
- `apps/backend/src/users/domain/repositories/User.repository.ts`
- `apps/backend/src/users/domain/repositories/index.ts`
- `apps/backend/src/users/domain/exceptions/UserNotFound.exception.ts`
- `apps/backend/src/users/domain/exceptions/InvalidUser.exception.ts`
- `apps/backend/src/users/domain/exceptions/index.ts`

Application Layer:

- `apps/backend/src/users/application/use-cases/GetUserProfile.uc.ts`
- `apps/backend/src/users/application/use-cases/GetUserProfile.uc.spec.ts`
- `apps/backend/src/users/application/use-cases/UpdateUserProfile.uc.ts`
- `apps/backend/src/users/application/use-cases/UpdateUserProfile.uc.spec.ts`
- `apps/backend/src/users/application/use-cases/DeleteUserAccount.uc.ts`
- `apps/backend/src/users/application/use-cases/DeleteUserAccount.uc.spec.ts`
- `apps/backend/src/users/application/use-cases/CreateUser.uc.ts`
- `apps/backend/src/users/application/use-cases/CreateUser.uc.spec.ts`
- `apps/backend/src/users/application/use-cases/GetAllUsers.uc.ts`
- `apps/backend/src/users/application/use-cases/GetAllUsers.uc.spec.ts`
- `apps/backend/src/users/application/use-cases/index.ts`
- `apps/backend/src/users/application/dtos/GetUserProfile.dto.ts`
- `apps/backend/src/users/application/dtos/UpdateUserProfile.dto.ts`
- `apps/backend/src/users/application/dtos/CreateUser.dto.ts`
- `apps/backend/src/users/application/dtos/index.ts`
- `apps/backend/src/users/application/services/User.service.ts`
- `apps/backend/src/users/application/services/index.ts`
- `apps/backend/src/users/application/mappers/User.mapper.ts`
- `apps/backend/src/users/application/mappers/index.ts`

Infrastructure Layer:

- `apps/backend/src/users/infrastructure/repositories/PrismaUser.repository.ts`
- `apps/backend/src/users/infrastructure/repositories/index.ts`
- `apps/backend/src/users/infrastructure/controllers/User.controller.ts`
- `apps/backend/src/users/infrastructure/controllers/index.ts`
- `apps/backend/src/users/infrastructure/mappers/User.mapper.ts`
- `apps/backend/src/users/infrastructure/mappers/index.ts`

Module Configuration:

- `apps/backend/src/users/Users.module.ts`

**Files to be Modified:**

- `apps/backend/src/app.module.ts` - Update import path to new Users.module

**Files to be Deleted:**

- `apps/backend/src/user/user.controller.ts`
- `apps/backend/src/user/user.controller.spec.ts`
- `apps/backend/src/user/user.service.ts`
- `apps/backend/src/user/user.service.spec.ts`
- `apps/backend/src/user/user.module.ts`
- `apps/backend/src/user/index.ts`
- `apps/backend/src/user/dto/` (directory - will be restructured)
- `apps/backend/src/user/entities/` (directory - will be restructured)
- `apps/backend/src/user/exceptions/` (directory - will be restructured)

## QA Results

_This section will be populated by the QA agent during review_

### Review Date

_To be filled during review_

### Reviewed By

_To be filled during review_

### Code Quality Assessment

_To be filled during review_

### Refactoring Performed

_To be filled during review_

### Compliance Check

_To be filled during review_

### Requirements Traceability

_To be filled during review_

### Recommended Status

_To be filled during review_
